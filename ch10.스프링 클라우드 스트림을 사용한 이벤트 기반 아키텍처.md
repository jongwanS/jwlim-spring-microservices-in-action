# 10. 스프링 클라우드 스트림을 사용한 이벤트 기반 아키텍처

## 10.1 메시징과 EDA, 마이크로서비스의 사례
### 10.1.1 동기식 요청-응답 방식으로 상태 변화 전달
![img_1.png](images/ch10/img.png)               
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  

**[서비스 간 강한 결합]**    
- 데이터를 조회하려고 `라이선싱 서비스`는 **조직 서비스에 의존**
- 조직 레코드가 업데이트시, `조직 서비스`가 **라이선싱 서비스 의존**

**[쉽게 깨지는 서비스 관계]**  
- 라이선싱 서비스가 다운되거나 느려지면 조직 서비스는 영향을 받는다.

**[조직 서비스의 변경에 관심 있는 새 서비스를 추가할 때의 경직성]**  
- 조직 데이터 변경에 관심이 있는 다른 서비스가 생겼다면 조직 서비스에서 그 서비스로 호출을 추가해야 한다.
- 상태 변경을 전달하려고 동기식 요청-응답 모델을 사용하면, 애플리케이션의 핵심 서비스와 다른 서비스 간에 `거미줄 같은 종속적 형태`가 된다.

> **또 다른 종류의 결합**
> - JSON 메시지 구조를 변경할 때 두 서비스가 동일한 메시지 타입에 대한 여러 버전을 적절히 처리하지 못한다면 자바로 상호 변환할 때 문제
>   - `버전 관리 기능이` 내장된 바이너리 프로토콜인 아파치 아브로

### 10.1.2 메시징을 사용한 서비스 간 상태 변화 전달
![img_1.png](images/ch10/img_1.png)               
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  
- 조직 데이터가 변경될 때 조직 서비스는 메시지를 토픽에 발행
- 상태 전달에서 `메시지 큐(토픽)`는 라이선싱 서비스와 조직 서비스 사이의 **중개자 역할**

**[느슨한 결합]**  
- 서비스가 소유한 데이터를 직접 관리하는 엔드포인트만 노출해서 **종속성을 최소화**
- 라이선싱 서비스는 메시지가 수신되었다는 것만 알고 **누가 발행했는지는 알지 못한다**

**[내구성]**  
- 큐가 있으면 서비스 소비자가 다운된 경우에도 **메시지 전달을 보장**

**[확장성]**  
- 큐에서 메시지를 읽어 오는 소비자가 메시지를 빠르게 처리하지 못한다면, 메시지 소비자를 더 많이 가동

**[유연성]**  
- **메시지 발신자**는 `누가 메시지를 소비`할지 **모른다**. 
- 원본 발송 서비스에 영향을 주지 않은 채 **새로운 메시지 소비자를 쉽게 추가**할 수 있음

### 10.1.3 메시징 아키텍처의 단점
- 메시지 기반 아키텍처는 복잡하다.

**[메시지 처리의 의미론]**  
- 애플리케이션이 메시지가 소비되는 순서에 따라 어떻게 동작하는지 알아야 한다.
- 메시지가 순서대로 처리되지 않을 때 어떻게 되는지를 이해해야 한다.
**[메시지 가시성]**  
- 메시지의 비동기적 특성으로 메시지가 발행되거나 소비되는 시점에 바로 수신 또는 처리되지 않을 수 있다.
**[메시지 코레오그래피]**  
- 메시징 기반 애플리케이션을 디버깅하려면 여러 다른 서비스의 로그를 모두 살펴보아야 한다. => 추적이 어렵다.

> **Note**
> - **메시징은 복잡하지만 강력**
> - 서비스에서 메시징을 사용할 때 `사전 숙고가 필요함을 강조`

## 10.2  스프링 클라우드 스트림 소개
- `스프링 클라우드 스트림`를 사용하면 스프링 기반 마이크로서비스에 **메시징을 쉽게 통합**할 수 있다.
- 스프링 클라우드 스트림은 우리가 사용하는 메시징 플랫폼의 세부 구현도 추상화

**[메시지 발행 & 구독]**  
![img_1.png](images/ch10/img_2.png)                 
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  

- 스프링 클라우드에서 메시지를 발행&소비 알아둬야할 네개의 컴포넌트
  - **소스**
    - 소스는 메시지를 받아 직렬화하고 메시지를 채널에 발행
  - **채널**
    - 메시지를 보내고 받는 큐
  - **바인더**
    - 특정 메시지 플랫폼과 통신하 는 스프링 코드
  - **싱크**
    - 들어오는 메시지 채널을 수신 대기, 메시지를 다시 객체로 역직렬화

## 10.3 간단한 메시지 생산자와 소비자 작성
![img_1.png](images/ch10/img_3.png)                 
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  

### 10.3.1 아파치 카프카 및 레디스 도커 구성
### 10.3.2 조직 서비스에서 메시지 생산자 작성
### 10.3.3 라이선싱 서비스에서 메시지 소비자 작성
![img_1.png](images/ch10/img_4.png)                 
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  


![img_1.png](images/ch10/img_5.png)                 
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  

### 10.3.4 메시지 서비스동작 보기

## 10.4 스프링 클라우드 스트림 사용 사례: 분산 캐싱
### 10.4.1 캐시검색을위한레디스
[스프링 데이터 레디스 의존성으로 라이선싱 서비스 구성]
[레디스 서버에 대한 데이터베이스 커넥션 설정]
[스프링 데이터 레디스 저장소 정의]

### 10.4.2 사용자 정의 채널 설정


## 10.5 요약

![img_1.png](images/ch10/img.png)               
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  