# 5. 스프링 클라우드 컨피그 서버로 구성 관리
- `애플리케이션 구성 정보`와 **코드를 분리하는 것은 중요**하다.
  - 분리 될시, 구성이 변경 될때 마다 컴파일 및 배포 불필요
- 많은 개발자가 `프로퍼티 파일(YAML, JSON, XML)`을 사용해 구성 정보를 저장한다. 
  - 애플리케이션 수가 적은 경우 효과가 있을수 있다.
  - 하지만, 수백 개의 서비스가 있을 경우에는 이 방식은 문제가 된다.

> 클라우드 기반 마이크로서비스 개발을 위한 모범 사례
> - 코드와 구성 정보를 완전히 분리한다.
> - 여러 환경에서도 절대 변경되지 않는 **불변 애플리케이션 이미지를 빌드**한다.
> - 서버가 시작할 때, **환경변수** 또는 **중앙 저장소**를 통해 **모든 애플리케이션 구성 정보를 주입**한다.

## 5.1 구성(그리고 복잡성) 관리
- 서비스 배포를 위해 수동으로 구성하거나 건드릴 경우 실수가 있을 수 있음.
  - 구성 불일치(configuration drift), 예기치 않은 장애, 확장시 위한 지연 시간 발생
- **구성 관리를 위해 지킬 네 가지 원칙**
  - `분리`
    - 서비스 물리적 배포에서 서비스 **구성 정보를 완전히 분리**해야 한다.
  - `추상화`
    - 애플리케이션 구성 정보를 조회하는 데 저장소(파일, DB)를 직접 읽기 보다는, 데이터 접근 방식을 추상화하여 **REST기반 JSON을 사용**해야 한다.
  - `중앙 집중화`
    - **가능한 적은 수의 저장소**로 애플리케이션 구성 정보를 모아야 한다.
  - `견고화`
    - 애플리케이션 구성 정보는 중앙 집중화되므로, **가용성**이 높고 **이중화**가 필요하다.
- **명심해야 할 핵심 사항 중 하나**
  - `애플리케이션 구성 데이터`는 `추적 가능`하며, `버전을 제어`할 수 있어야 한다.

### 5.1.1 구성 관리 아키텍처
[그림 5-1] 애플리케이션 구성 데이터는 **서비스 부트스트래핑 단계**에서 읽힌다.
![img_1.png](images/ch05/img.png)      
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판    

[그림 5-2] 상세한 부트스트래핑 과정
![img_1.png](images/ch05/img_1.png)     
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판    
1. 인스턴스가 시작되면, 환경별 구성 정보를 읽어 온다
2. 구성 정보는 저장소(파일, DB, key-value 저장소)에 보관된다.
3. 구성 관리에 대한 변경 사항은 빌드 및 배포 파이프라인으로 처리
4. 구성 정보가 변경시, 서비스는 변경 사항을 통지받고 애플리케이션 데이터 복제본을 갱신 해야 한다.

### 5.1.2 구현 솔루션 선택
[표 5-1] 구성 관리 솔루션
![img_1.png](images/ch05/img_2.png)         
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  
- 책 에서는 `스프링 클라우드 구성 서버(Spring Cloud Configuration Server)`를 채택

## 5.2 스프링 클라우드 컨피그 서버 구축
- 스프링 클라우드 컨피그 서버는 `REST 기반`의 **애플리케이션** 이다.
- 부트스트랩(bootstrap) 파일은, `애플리케이션 이름`, `스프링 클라우드 구성 서버 위치`, `암호화/복호화 정보` 등을 지정한다.
  - application.properties나 application.yml 파일을 사용하는 컴포넌트보다 먼저 로드

````yaml
spring:
  application:
    name: config-server #컨피그 서버 애플리케이션 이름 
server:
  port: 8071 #서버 포트
````

### 5.2.1 스프링 클라우드 컨피그 부트스트랩 클래스 설정
- 부트스트랩 클래스를 설정
````java
@SpringBootApplication
@EnableConfigServer //이 서비스룰 스프링 클라우드 컨피그 서비스로 활성화
public class ConfigurationServerApplication {
	public static void main(String[] args) {
		SpringApplication.run(ConfigurationServerApplication.class, args);
	}
}
````

### 5.2.2 스프링 클라우드 컨피그 서버에 파일 시스템 적용
- `스프링 클라우드 컨피그 서버`는 bootstrap.yml 파일에서 애플리케이션의 **구성 데이터를 보관할 저장소를 지정**한다.
````yaml
spring:
  application:
    name: config-server
  profiles:
    active: native #백엔드 저장소(파일시스템)와 관련된 스프링 프로파일을 설정한다.

  cloud:
    config:
      server:
      # 로컬 구성 정보: classpath 위치나 파일 시스템의 위치가 될 수 있다.
        native:
        # 특정 파일 시스템 폴더에서 읽어 온다.
          search-locations: file:///(FILE_PATH) #구성 파일이 저장된 검색 위치를 설정한다.
          #search-locations: classpath:/config 클래스패스
server:
  port: 8071
````
### 5.2.3 서비스의 구성 파일 설정
[그림 5-5] 컨피그 서비스를 설정&사용 하는 방법
![img_1.png](images/ch05/img_3.png)         
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  

> 구현 전 생각하라
> - 중대형 클라우드 애플리케이션에는 파일 시스템 기반 솔루션을 권장하지 않는다.

- http://localhost:8071/licensing-service/dev
  - default와 dev의 구성 프로퍼티를 모두 반환
![img_1.png](images/ch05/img_4.png)         
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판

## 5.3 스프링 클라우드 컨피그와 스프링 부트 클라이언트 통합
### 5.3.1 라이선싱 서비스의 스프링 클라우드 컨피그 서비스 의존성 설정
### 5.3.2 스프링 클라우드 컨피그 사용을 위한 라이선싱 서비스 구성
### 5.3.3 스프링 클라우드 컨피그 서버를 사용하여 데이터 소스 연결
### 5.3.4 @ConfigurationProperties 를 사용하여 프로퍼티 직접 읽기
### 5.3.5 스프링 클라우드 컨피그 서버를 사용하여 프로퍼티 갱신
### 5.3.6 깃과 함께 스프링 클라우드 컨피그 서버 사용
### 5.3.7 볼트와 스프링 클라우드 컨피그 서비스 통합


## 5.4 중요한 구성 정보 보호
## 5.5 마치며
## 5.6 요약
