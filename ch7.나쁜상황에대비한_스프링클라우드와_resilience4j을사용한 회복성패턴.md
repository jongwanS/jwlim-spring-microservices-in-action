# 7. 나쁜 상황에 대비한 스프링 클라우드와 Resilience4j 를 사용한 회복성 패턴
- 모든 시스템, 특히 분산 시스템은 실패를 겪는다. => 실패에 대응하는 애플리케이션 구축방법은 중요하다.
- 보통 회복성을 갖춘 시스템을 구축할 때, `인프라스트럭처`나 `중요 서비스의 한 부분이 실패한 경우`만 고려한다. => 회복력 있는 시스템 구축에 있어 작은 한 부분에 문제만 해결할 뿐이다.
- 서비스가 망가지면 쉽게 우회할 수 있지만, **서비스가 느려진다면 성능 저하를 감지하고 우회하는 일은 매우 어렵다.**
  - **서비스 성능 저하**는 간헐적으로 시작되어 **확산**될 수 있다.
    - 애플리케이션 컨테이너 스레드 풀 소진 등..
  - 원격 서비스 호출은 대개 **동기식**이며 장기간 수행되는 호출을 중단하지 않는다.
    - 호출자에게는 서비스 호출이 행되는 것을 방지하는 타임아웃 개념이 없다. => 설정을 통해 극복
  - 대개 원격 자원의 부분적인 저하가 아닌 **완전한 실패를 처리하도록 애플리케이션을 설계**한다.
    - 계속해서 불량한 서비스를 호출하고 빠르게 실패하지 못하는 경우가 많다. => 자원고갈(스레드 풀, 컨네션 풀) 로 고장 날 가능성이 더 높다.
- 보호장치가 없다면 불량한 서비스 하나가 빠르게 **여러 애플리케이션을 다운**시킬 수 있다.
- **회복성 패턴**은 MSA에서 가장 중요한 요소 중 하나이다.

## 7.1 클라이언트 측 회복성이란?
- `클라이언트 측 회복성`이란 `에러나 성능 저하로 원격 자원이 실패`할 때 **클라이언트가 고장 나지 않게 보호하는 데 초점**을 둔다.
  - 빨리 실패하여, 자원고갈을 방지 할 수 있다.
[그림 7-1] 네 가지 클라이언트 회복성 패턴, **서비스 소비자 및 소비자 사이에서 보호대 역할**
![img_1.png](images/ch07/img.png)  
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  

### 7.1.1 클라이언트 측 로드 밸런싱
- `클라이언트 측 로드 밸런싱`은 디스커버리 에이전트(ex,유레카)에서 서비스 인스턴스를 검색후, 해당 인스턴스들의 물리적 위치를 캐싱하는 작업을 의미한다.
- `클라이언트 측 로드 밸런서`는 서비스 클라이언트와 소비자 사이에 위치하여, 특정 인스턴스에 문제 발생시 탐지할 수 있다.
- `클라이언트 측 로드 밸런서`가 문제를 탐지하면 문제된 서비스 인스턴스를 제거하여, 해당 인스턴스를 더 이상 호출하지 않게 된다.
### 7.1.2 회로 차단기
- `소프트웨어 회로 차단기`는 **원격 서비스 호출**될 때 **호출을 모니터링**한다.
- 호출이 너무 오래 걸리면, 차단기가 개입해서 호출을 종료한다.
### 7.1.3 폴백 처리
- `폴백 패턴`을 사용하면, 서비스 **호출 실패시 예외를 생성하지 않고** 대체코드 경로를 실행하여 **다른 수단을 통해 작업을 수행**한다.
  - ex) 다른 데이터 소스에서 데이터를 찾거나, 요청을 큐에 입력 
### 7.1.4 벌크헤드
- `벌크헤드 패턴`을 사용할 때 원격 자원에 대한 호출을 스레드 풀로 분리하면, 전체 애플리케이션을 다운시킬 위험을 줄일 수 있다.
  - 스레드 풀별로 서비스를 할당하면 다른 서비스는 포화되지 않기 때문에 병목 현상을 우회할 수 있다.

## 7.2 클라이언트 회복성이 중요한 이유
## 7.3 Resilience4j 구현
## 7.4 스프링 클라우드와 Resilience4j를 사용하는 라이선싱 서비스 설정
## 7.5 회로 차단기 구현
## 7.6 폴백 처리
## 7.7 벌크헤드 패턴 구현
## 7.8 재시도 패턴 구현
## 7.9 속도 제한기 패턴구현
## 7.10 ThreadLocal과 Resilience4
## 7.11 요약


![img_1.png](images/ch07/img.png)  
출처 : 길벗 - 스프링 마이크로서비스 코딩 공작소 개정2판  